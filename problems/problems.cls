\pdfminorversion=4 % force pdf 1.4 output; http://tex.stackexchange.com/questions/95973/is-pdftex-1-40-13-outputting-malformed-pdfs
\RequirePackage{pdf14}% workaround for a bug in older pdftex; http://tex.stackexchange.com/a/87946/6853
\NeedsTeXFormat{LaTeX2e}
\ProvidesClass{problems}
\LoadClass[twocolumn]{book}
\usepackage[paperwidth=8.5in,paperheight=11in]{geometry}
\usepackage{shaddap,lmmath,amsmath,amssymb,cancel,titlesec,ifthen,makeidx,graphicx}
%
\newcommand{\intro}[1]{\emph{#1}}
%%%%%%%%%%%%%%%%% math %%%%%%%%%%%%%%%%%%%
\newcommand{\eqquad}{}
%%%%%%%%%%%%%%%%% figures %%%%%%%%%%%%%%%%%%%
\newcommand{\sharedfigs}{}% gets redefined, typically for each chapter, by .tex generated by generate_problems.rb
\newcommand{\figraw}[4]%
  % #1=file, #2=placement, #3=caption, #4=width
  {%
    \begin{figure}[#2]
    \begin{center}\includegraphics[#4]{../../\sharedfigs/#1}\end{center}
    \caption[]{#3}\label{fig:#1} % empty [] is a workaround for this bug: http://tex.stackexchange.com/a/227840/6853
    \end{figure}
  }
\newcommand{\fig}[3]{\figraw{#1}{#2}{#3}{width=0.5\textwidth}}
\newcommand{\fignarrow}[3]{\figraw{#1}{#2}{#3}{width=52mm}}
%\newcommand{\fignarrow}[3]{}
%%%%%%%%%%%%%%%%% problems %%%%%%%%%%%%%%%%%%%
\newcommand{\hwtriangle}{$\triangleright$}
\newcommand{\hwsoln}{\hwaddtrailingstuff{\hwtriangle\ Solution, p. \pageref{soln:\currenthwlabel}}}
\newcommand{\answercheck}{\hwaddtrailingstuff{\hwcheckmark}}
\newcommand{\hwcheckmark}{\scriptsize\raisebox{1mm}{$\surd$}\normalsize}
\newcommand{\hwendpart}[1][3]{\hwflushtrailingstuff[#1]\\}
%	The optional argument ends up being passed to \nolinebreak. It defaults to 3, but
%	you can make it 2 or 4 if it seems to be making the wrong decision.
%   If there is only one part to the problem, or if you're fiddling with the very last
%   part of a multipart problem, I think you can add a gratuitous \hwendpart, but
%   except in this situation, don't do \hwendpart after the last part, because sometimes
%   it causes extra blank lines to appear.
%
\newcommand{\hwfill}[1]{\hspace*{\fill}\nolinebreak[#1]\nopagebreak[1]\hspace*{\fill}}
% ... cf LaTeX Companion, p. 443
\newcommand{\hwdifficulty}{0}
% ... This needs to be a global variable because I only display the symbol in  \end{hw},
%     which doesn't have access to #1.
\newcommand{\displayhwdifficulty}[1]{\ifthenelse{\equal{#1}{0}}{}{\ifthenelse{\equal{#1}{1}}{$\star$}{\ifthenelse{\equal{#1}{2}}{$\star\star$}{\ifthenelse{\equal{#1}{3}}{$\star\star\star$}{x}}}}} % qwe
\newsavebox{\hwtrailingstuff}
% There is also a boolean register, hwhavetrailing, defined under AtBeginDocument.
%
% The homework problem section is supposed to be like any other section, but not numbered.
% addtocontents: see Lamport, p. 176
\newcommand{\currenthwlabel}{}
\newcommand{\hwflushtrailingstuff}[1][3]{\ifthenelse{\boolean{hwhavetrailing}}{\hwfill{#1}\usebox{\hwtrailingstuff}\hwcleartrailingstuff}{}}
%
\newcommand{\hwcleartrailingstuff}{\sbox{\hwtrailingstuff}{}\setboolean{hwhavetrailing}{false}}
%
\newcommand{\hwaddtrailingstuff}[1]{\sbox{\hwtrailingstuff}{\usebox{\hwtrailingstuff}\quad{}#1}%
                                             \setboolean{hwhavetrailing}{true}}
%
\newenvironment{hw}[4]
       % #1=name, #2=difficulty, #3=calc, #4=label (e.g., a3)
       % based on the homeworkforcelabel environment in lmcommon.sty
       {\begin{samepage}
        \renewcommand{\@currentlabel}{#4}\label{hw:#1}\noindent\textbf{#4}%
        \renewcommand{\currenthwlabel}{#4}
        \renewcommand{\hwdifficulty}{#2}%
        \quad%
        }
        {%
             \hwaddtrailingstuff{%
                                \displayhwdifficulty{\hwdifficulty}
                            }%
             \hwflushtrailingstuff\par%
             \vspace{\stretch{1}}%
                    % Put any available extra whitespace between problems.
                    % Half as big as what's generated by hw_block().
             \end{samepage}
        }
%
%%%%%%%%%%%%%%%%% answers %%%%%%%%%%%%%%%%%%%
\newcommand{\solnhdr}[1]{\noindent\textbf{#1}\quad}
%%%%%%%%%%%%%%%%% titlesec %%%%%%%%%%%%%%%%%%%
\titleformat{\chapter}
  {\normalfont\huge\bfseries}
  {\thechapter}{1em}{}
\titleformat{\subsection}
  {\normalfont\large\itshape}
  {}{0em}{}
%========================= AtBeginDocument stuff=========================
\AtBeginDocument{
  \newboolean{hwhavetrailing}
}
